<?xml version="1.0" encoding="utf-8"?>
<!--
    eduVPN - VPN for education and research

    Copyright: 2017-2021 The Commons Conservancy eduVPN Programme
    SPDX-License-Identifier: GPL-3.0+
-->

<?define LanguageList=ar;de;fr;nb;nl;pt-PT;sl;tr;uk?>

<?if $(var.ClientTarget) = "eduVPN"?>
    <?define libcrypto_1_1.dll.ComponentGUID = "{BF2C61B2-2970-49F3-812A-6DEB4A15870C}"?>
    <?define libssl_1_1.dll.ComponentGUID = "{55E6958F-DF31-4742-91A3-904FB0102150}"?>
    <?define liblzo2_2.dll.ComponentGUID = "{4C072186-6C47-49B3-B945-D09503A20FB3}"?>
    <?define libpkcs11_helper_1.dll.ComponentGUID = "{1D7D0360-15AD-466F-B667-840C8C8827C5}"?>
    <?define openvpn.exe.ComponentGUID = "{101FF3BB-DD5A-41CB-8A8C-0B582F7BF1D7}"?>
    <?define openvpnserv.exe.ComponentGUID = "{1A38AF86-1516-49FA-91AE-D48EAE37468D}"?>
    <?define openvpnserv.exe.reg0.ComponentGUID = "{95745DBA-88C1-4FD6-AF79-2D34B2E9D4F4}"?>
    <?define openvpnserv.exe.reg1.ComponentGUID = "{457AD4F6-7330-409B-8AA9-11C5AA17B2AD}"?>
    <?define openvpnserv.exe.reg2.ComponentGUID = "{5A36E0F2-D707-4A43-A039-2D6B4231BF23}"?>
    <?define openvpnserv.exe.reg3.ComponentGUID = "{3D89AA2C-04E3-49C2-A2BC-19B957ED4F74}"?>
    <?define openvpnserv.exe.reg4.ComponentGUID = "{E551E92B-B79A-41E7-909C-656AEDDFAE1C}"?>
    <?define openvpnserv.exe.reg5.ComponentGUID = "{9C350B91-873A-4F0F-BBDD-D422071AE78C}"?>
    <?define openvpnserv.exe.reg6.ComponentGUID = "{D59FD7FA-E687-4A43-B8A2-077ECDD02B6D}"?>
    <?define openvpnserv.exe.reg7.ComponentGUID = "{2140688F-04A2-42C9-B9C8-1314B721C82D}"?>
    <?define System.ValueTuple.dll.ComponentGUID = "{2D4A9678-39A8-4623-8903-DCA55E9C24F4}"?>
    <?define Prism.dll.ComponentGUID = "{7F1F7FAC-3959-40D5-A379-AE70762D6335}"?>
    <?define Client.exe.ComponentGUID = "{ED87A5F5-CCED-46EA-8D4E-443CA747E4D8}"?>
    <?define Client.exe.config.ComponentGUID = "{8382A373-0C73-4D16-8F33-CA9FF91C24D0}"?>
    <?define OldProductGUIDs={03CB2E09-0CAD-469B-AB45-655D66FE3B65};{0841DE4F-F902-41E6-B0CD-820A36D52B0E};{08EFF53C-15CB-4CE5-BA6E-8C93274B795E};{0B43FFC8-2FCD-461E-A2AE-16F9DC6A183D};{0E05ED6A-162E-490D-A86B-4D1754B73586};{0E142612-80B6-41DA-B018-CDB5AD4755AD};{0ECF4980-96D5-47B5-B1E0-FDDBEF02BF54};{12E71E11-B4B2-4F9D-8D0C-2D8DE2912637};{14ACE545-3D1E-4261-8E3E-D09389B7DC45};{1C44BEDC-0BA8-4AA5-B256-35358AA63D37};{20607E48-5B55-49A0-85FA-324B88405825};{20C03B25-2908-4B88-A9B4-43BACEE9F0D1};{26C061F4-0B3C-4504-87F5-1242186FD3E4};{2BBA222F-8D7B-4753-B3D8-98C67A9600CF};{2DD2C4E5-02ED-415E-A32F-1D3864715A56};{30DDCF52-4B2D-4D19-BC08-D65240DB321F};{37F3A6BD-34BA-4495-B6D2-906BB7AE7F90};{3827A306-CF9D-4563-9A49-592452B3B2B3};{3B2B4912-3847-4D91-A326-B96094959E8B};{41FE8D9A-4F4E-4C9D-8FA0-2C084D8AA2D2};{476E2607-8BA4-42B0-8B30-B6AC07158419};{47A7E1A5-A9D1-4B50-AF87-42CE5213A843};{4B3862B7-C58C-459C-B470-CA16BA4A68CB};{5116EF0B-FC1D-4310-8B31-8F2B00B2CBBF};{5232255B-AEFF-48EB-B7D2-D9DDE5EB9239};{5461A901-8935-4D30-A1E2-78EF195D4EC2};{58C633A1-6357-42A4-9953-91EC71C71450};{5A6DD426-111A-4DD2-AA89-4F036D0F4C48};{5CDB1F77-0AC9-41DD-8B5D-6B3E2A97C898};{5EFB583A-FAAE-4CDA-B2DD-80CE51C3B9A0};{5FC9442C-7B87-4E23-8085-DDAC61549D91};{60634577-01E3-4B26-8D8A-57ED6BAD3CBA};{60B2F5C3-F34A-4812-B9C0-6DFEBFF09A1D};{60E84675-E746-4603-B251-5B47F66CBFA4};{739A267F-5B41-4828-AC35-41E7B7683856};{78738805-E2DC-407B-89E7-A26D789BAF9E};{7A818601-E231-4A33-A3D0-775A05A2D4A6};{7B1FBFE6-92B3-4B6D-A808-A26DF770606A};{7FD5B9C8-1C74-4789-BF33-87E3A6EF6CE6};{803E3649-24C4-4F8B-AB5E-59EE7B3736BF};{81292611-58F5-4893-908D-653FC8F2BEA5};{82794A05-BA03-47F6-BFBC-07D8D29F5E84};{82AD5A76-89BA-466B-8EAF-339FC95125CC};{852699DE-2476-4B5F-88E7-FF6E4F8857B8};{85BCE1C8-4A69-4F21-8509-2E02F72355FF};{88A64758-C09D-4CFF-ADD8-2D02BF9262B7};{8AA8BC85-09C9-47D0-8284-3E79D64D88F1};{8C3E9E9C-CC76-4F8D-A6EB-B2355451F938};{93D94585-B36B-4199-9D2A-8AB6BA6B6D1E};{94EB5DFF-78AD-4DC8-B663-B8017C00EE3C};{955AAA6D-EDEE-42E5-A4BD-DB2BE2052676};{9A7F021A-EB4C-401C-9196-60589CE51C70};{9C29CA3B-6C6D-4ED6-8573-89E8DAE89E05};{9DAA52BC-511D-4547-8083-BDA9880291C7};{9FC10C3C-C5C8-4830-B0C4-DF18DA1A1394};{A2BC5B6A-7DF3-4BC4-AB30-A8492DAD41D2};{ADF3E7EE-82D8-4BB8-8698-FD52832CD701};{B142EC9C-D49D-45D8-A6F6-23B635F55BF5};{B2BCB303-6FDE-45F3-9760-E3E77BDB6607};{C28834F3-EE73-4BE1-AEE3-82E77D4DC722};{C2C12548-4F1B-4E20-B376-39A54C5F371F};{C3D2B5A6-3B91-4F1B-B42C-98A9F3050E73};{C74A763B-1EA0-4473-B2C5-F47AFBE4F808};{C80A6D07-DFFC-468B-BDF8-96F1D027E949};{C94815B1-25BF-4F42-950E-3445895FEDC3};{CD8D16F9-340D-4865-9164-9D0EE4B6F77C};{CFEF527D-232C-49D5-9A86-BEF160F048BE};{D73B4DFB-57DC-47E6-ACA9-30E8959F3EA0};{D8AD66E1-C27C-4D68-B334-B7183A36ABDA};{E1E80171-6002-403A-A896-CB6D97C5DB80};{E66CCFAF-E026-405A-9CBE-F85248F4FBA4};{E83C358E-BFFA-4600-83BA-E0B4DB1662D4};{E9B7F177-C6A8-49D7-AD62-D44762FFF209};{EAA1D8B1-192B-4CF9-A94F-3565F33E0F7F};{EC67F277-0699-4DB8-BA80-38E80593CB43};{F018B421-F402-43E6-A0BE-2B9143C24CAD};{F1494643-7CF6-4C15-BE70-D9C06581DE2D};{F53CCDEE-9507-492F-ABF4-02630BB90B13};{FD027AB5-F028-4613-A61D-DCD4CE2BCB1B}?>
<?elseif $(var.ClientTarget) = "LetsConnect"?>
    <?define libcrypto_1_1.dll.ComponentGUID = "{3BB68B8B-913D-47BF-B092-CCC7CBB9A7CC}"?>
    <?define libssl_1_1.dll.ComponentGUID = "{D58368FD-3678-4762-9E5E-2F19A8E7613E}"?>
    <?define liblzo2_2.dll.ComponentGUID = "{D073932D-4ECF-480C-B54A-4FEBCE3FB015}"?>
    <?define libpkcs11_helper_1.dll.ComponentGUID = "{8EFE985A-9800-440D-8517-DAEFB50ECA74}"?>
    <?define openvpn.exe.ComponentGUID = "{46C7AD2F-6AA7-408A-BD02-9E8C59DD8C76}"?>
    <?define openvpnserv.exe.ComponentGUID = "{D54DD0B1-8C81-42F8-BD3F-BB988B786782}"?>
    <?define openvpnserv.exe.reg0.ComponentGUID = "{CD0E5551-72D5-487C-ADB6-3FF86EA83CC1}"?>
    <?define openvpnserv.exe.reg1.ComponentGUID = "{7EF617D1-1B9E-4B96-A4C7-9A4597370AA2}"?>
    <?define openvpnserv.exe.reg2.ComponentGUID = "{5E0F8717-1CCF-40B3-A3FE-AFE367973C73}"?>
    <?define openvpnserv.exe.reg3.ComponentGUID = "{CF896642-99B2-4BD1-9FD2-89E73F3C38B2}"?>
    <?define openvpnserv.exe.reg4.ComponentGUID = "{F9F27191-D01C-4DF2-8112-288B9D086628}"?>
    <?define openvpnserv.exe.reg5.ComponentGUID = "{2D450249-CCD0-4C4C-AD9A-793C864FE1B7}"?>
    <?define openvpnserv.exe.reg6.ComponentGUID = "{EB68C746-5E50-4F66-9A21-2E6BB07EEA38}"?>
    <?define openvpnserv.exe.reg7.ComponentGUID = "{A40AFCF3-E0DE-4844-91CE-64D55C3FA8B5}"?>
    <?define System.ValueTuple.dll.ComponentGUID = "{F53A7176-4E78-4EB1-BE22-24296A5925EF}"?>
    <?define Prism.dll.ComponentGUID = "{9B4F3694-9A5E-41AF-AA24-E2E5F39A48C6}"?>
    <?define Client.exe.ComponentGUID = "{0405C4A5-06F1-4B2A-8F7B-7BE66F7DD8E4}"?>
    <?define Client.exe.config.ComponentGUID = "{03C290E0-70A5-4594-9801-F51D07CCF06B}"?>
    <?define OldProductGUIDs={062F3398-EA38-4BFF-B440-4A1D918B5D82};{068A54FD-D7B6-4184-BBE8-3F9F861B43C2};{0B44A7F9-A558-469F-B3B7-ADA13A8A58A1};{10C139AD-CA69-4520-A903-FF4A6716D81D};{14907F3E-26D1-4DF1-A002-705E6E07699E};{18DCDA1E-F906-4065-ACB5-08C750CEA7B9};{1E0B0573-624D-4B43-A2F7-ABB3A9E5BEE4};{24CEF599-2910-4731-B1AF-C638B813D3B8};{27D2998E-A8C3-4BE4-A953-C8FC487EE4F4};{2ABB1BDC-4260-4FE5-BABA-26B9C0A42499};{2D25D49E-A818-42FD-8A2A-2FAEC959BB58};{2D2E03D4-8363-46F6-9B65-3733AB7B8454};{3123FED0-DEE0-4CDE-AB82-D25BA33194BD};{327A682E-CFB4-434B-A486-E021DBCD3DB0};{3530C188-0D30-4205-A772-234E1AC913CD};{38096ECD-CEA4-449A-8C17-8A6E4B4C2FAF};{3B2CFCC2-382D-48EA-AC10-AA495ADDF660};{3C594C0B-A2A8-4CE5-BF86-759E9E7B7C25};{40CF54B6-86CD-4A15-A60D-994BCABF841E};{41D9C0F1-9877-4F10-855C-3DAC094962D8};{433DCD39-5308-4E8C-AB16-BB8DC2DD0E9D};{47DF50B7-5F60-4BF8-A93B-A84AB10860DB};{4A65C3E8-2A61-47EE-AB13-B01285963F38};{4A8EC4D4-DCF4-4BD0-8108-F9042BEBA9A0};{4C1FCC7F-758F-44D7-9159-6AD0861A9E58};{4F24A76F-3164-468E-BCE0-AB0D81C7867B};{4F91C80E-9B6F-4CC2-B8A2-9945498EBE6D};{526F6F8D-CB02-4DF6-A9C7-2510EFF0DA1A};{5318F5AC-77A7-4F30-994A-F09A0EE93182};{56A22ECA-46DF-4ACC-9359-526982807A8B};{592963B9-A191-41B0-9995-BC4189041343};{5A26D864-2565-4669-8518-6902670F9557};{5DBA7ECE-7A76-4660-92D0-E73ADC3A8B1F};{5F4812FA-5A9C-4E6B-B358-7970E4D14676};{60C0F2D8-6705-45A8-9677-6199D44A160D};{60D4CEB2-F29B-470A-A0E3-E90FC0F0E7A1};{63E96A6D-6757-463A-BBC1-9A5A1856CCBB};{68180E72-7C03-4A8D-8D41-E902B55E92A7};{6AB91B3D-2CBA-43A5-B665-1F37BFA63BFD};{6B4EA58C-BB18-42C4-A44B-529AEB275068};{6D844C90-FF59-4143-AD53-4AF4A739BD6C};{6DFD6EFC-33CB-4596-9484-BBC90CC325E8};{7022FAF9-E0C0-4DD1-BB87-AD2910680868};{70BEFAA0-2C48-4BE9-BB21-63D7CD365A84};{71641521-F4D5-4633-BBD1-A8701BCDA8B5};{81F3BF17-9801-424A-94F8-DD54E985A2CE};{81FE1967-7C3D-465E-8E41-6201D26603D8};{82AC2CC1-2C22-4A73-9987-582D4BAD8442};{85C9141F-C87A-4625-9518-899465ADB082};{8ABC985A-3AF3-40DC-87D7-F7B96C0C63BE};{8D75C336-E926-4DC8-9BA8-213405254704};{8E5468C9-48BA-4498-B24A-57D3C5781785};{951A4B8E-6347-47CC-BF72-002DE45F1234};{9A5492D7-F0DC-478D-B26D-A1241D0E212A};{9FAACD32-CFB7-4549-9355-07756B9BAD93};{A03D6006-38CE-44FA-914C-08F9A1E8BBD3};{A5CE0B40-C55B-43D7-9835-332DEB32AF80};{A7431B7A-23F3-4D10-829B-92D5A229265E};{AE73690F-0781-4D6C-8FED-B64B7F121165};{B0216147-E14D-49AB-A4D2-9ACA3FA0A8AC};{B78C46A9-3CBF-48F6-BE20-AD89A3FB2204};{B8EAB40E-6B80-4E12-B0CF-106A30D1827F};{BEC9F285-D9F9-4A23-8CC0-B8E043FC9E53};{BEEE0D5B-89C1-42F5-B300-E0135D59541E};{C524F93F-60A7-44B3-963F-EF50FA376BEC};{C593CEB2-5A9F-4AB1-89D3-27AE73818074};{CACC6157-5502-4DA8-9F3B-8B099CF010D8};{D0CD2DD8-F2FC-4A08-A55C-41E292AEB969};{DAB10C94-809C-4FB3-9FBB-56039D0003C1};{DB79D09C-F5DB-4641-9FC1-6B935B454A1E};{DD4C2AA6-5CB0-4487-9195-D55397F4F606};{E770119C-DC10-4E81-9025-D59DFCC3AB1B};{E83D9B53-73E8-47BB-B384-FB6985094730};{E972CFF8-C88F-4329-AE04-54EF66907605};{F0DE4E27-92B4-4507-880B-C9FEAF01CB22};{FA39751B-0E5A-434B-A667-F459BC0FF31C};{FD840DF5-1E0A-47FC-8A4B-79736CA30573};{FDBF4850-F78E-4B4C-8D07-8085983537EB};{FE8D1F27-AE8D-40A7-898C-24278F5A8750}?>
<?else?>
    <?error Unknown client?>
<?endif?>

<Wix
    xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
    <Product
        Id="$(var.ProductGUID)"
        UpgradeCode="$(var.UpgradeGUID)"
        Version="$(var.Version)"
        Language="!(loc.ProductLanguage)"
        Name="!(loc.$(var.ClientTarget).Name) $(var.VersionInformational)"
        Manufacturer="!(loc.ManufacturerName)">

        <Package
            InstallScope="perMachine"
            InstallerVersion="400"
            Compressed="yes"
            SummaryCodepage="!(loc.SummaryCodepage)"
            ReadOnly="yes"/>

        <Media
            Id="1"
            Cabinet="Client.cab"
            EmbedCab="yes"/>

        <Icon
            Id="App.ico"
            SourceFile="$(var.ClientTarget).Client\Resources\App.ico"/>

        <Binary
            Id="OpenVPN.MSICA.dll"
            SourceFile="OpenVPN.MSICA.dll"/>

        <Property Id="ARPPRODUCTICON" Value="App.ico"/>
        <Property Id="ARPURLINFOABOUT" Value="$(var.ClientAboutUri)"/>
        <Property Id="WINTUNPOOL" Value="OpenVPN$$$(var.ClientTarget)"/>


        <!--
            Upgrading functionality
        -->
        <MajorUpgrade
            DowngradeErrorMessage="!(loc.NewerVersionInstalled)"
            Schedule="afterInstallExecute"
            AllowSameVersionUpgrades="yes"/>
        <?if $(var.ClientTarget) = "eduVPN"?>
        <Property Id="OLDVERSIONSINSTALLED" Secure="yes"/>
        <Upgrade Id="{ADD9689E-1061-43AF-85C6-2AAB99A7284E}">
            <UpgradeVersion
                Minimum="0.0.0.0"
                Maximum="1.0.10.0"
                Property="OLDVERSIONSINSTALLED"
                IncludeMinimum="yes"
                MigrateFeatures="yes"/>
        </Upgrade>
        <?endif?>
        <Property Id="TAPWININSTALLED" Secure="yes"/>
        <Upgrade Id="$(var.TAPWin.UpgradeGUID)">
            <UpgradeVersion
                Minimum="0.0.0.0"
                Property="TAPWININSTALLED"
                IncludeMinimum="yes"
                MigrateFeatures="no"
                IgnoreRemoveFailure="yes"/>
        </Upgrade>
        <Property Id="OPENVPNINSTALLED" Secure="yes"/>
        <Upgrade Id="$(var.OpenVPN.UpgradeGUID)">
            <UpgradeVersion
                Minimum="0.0.0.0"
                Property="OPENVPNINSTALLED"
                IncludeMinimum="yes"
                MigrateFeatures="no"
                IgnoreRemoveFailure="yes"/>
        </Upgrade>
        <?if $(var.ClientTarget) = "eduVPN"?>
        <Property Id="OLDOPENVPNINSTALLED" Secure="yes"/>
        <Upgrade Id="{CFE55281-AE4B-42A8-A1C3-76E94A733341}">
            <UpgradeVersion
                Minimum="0.0.0.0"
                Maximum="2.4.4.1"
                Property="OLDOPENVPNINSTALLED"
                IncludeMinimum="yes"
                IncludeMaximum="yes"
                MigrateFeatures="no"
                IgnoreRemoveFailure="yes"/>
        </Upgrade>
        <?endif?>
        <Property Id="OPENVPNDIRPREV">
            <ComponentSearch Id="openvpnserv.exe" Guid="$(var.openvpnserv.exe.ComponentGUID)"/>
        </Property>
        <SetProperty
            After="AppSearch"
            Action="SetOpenVPNDirPrev"
            Id="OPENVPNDIR"
            Value="[OPENVPNDIRPREV]"
            Sequence="first"><![CDATA[OPENVPNDIRPREV AND NOT Installed]]></SetProperty>
        <Property Id="COREDIRPREV">
            <ComponentSearch Id="$(var.ClientTarget).Client.exe" Guid="$(var.Client.exe.ComponentGUID)"/>
        </Property>
        <SetProperty
            After="AppSearch"
            Action="SetCoreDirPrev"
            Id="COREDIR"
            Value="[COREDIRPREV]"
            Sequence="first"><![CDATA[COREDIRPREV AND NOT Installed]]></SetProperty>


        <!--
            .NET Framework check
        -->
        <PropertyRef Id="NETFRAMEWORK45"/>
        <Condition Message="!(loc.DotNETFrameworkMissing)"><![CDATA[Installed OR NETFRAMEWORK45]]></Condition>


        <!--
            Folders
        -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.ProgramFilesFolder)">
                <Directory Id="PRODUCTDIR" Name="$(var.ClientTitle)" FileSource="$(var.TargetDir)">
                    <Directory Id="RESDIR" Name="Res" FileSource="$(var.TargetDir)"/>
                    <Directory Id="OPENVPNDIR" Name="OpenVPN" FileSource="$(var.TargetDir)">
                        <Directory Id="OPENVPNCONFIGDIR" Name="config"/>
                    </Directory>
                    <Directory Id="COREDIR" Name="Core" FileSource="$(var.TargetDir)">
                        <?foreach Language in $(var.LanguageList)?>
                        <?include Install\$(var.Language)\defs.wxi?>
                        <Directory Id="RESOURCEDIR$(var.LanguageId)" Name="$(var.Language)"/>
                        <?endforeach?>
                    </Directory>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder"/>
            <Directory Id="DesktopFolder"/>

            <Merge Id="VC150Redist" SourceFile="$(var.VC150RedistMSM)" DiskId="1" Language="0"/>
        </Directory>


        <!--
            Compontents
        -->
        <DirectoryRef Id="RESDIR">
            <Component Id="eduVPN.Resources.dll" Guid="{F6C90B86-77AC-49A6-B3$(var.ClientId)-5BCF15028CFA}">
                <File Source="eduVPN.Resources.dll"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="OPENVPNDIR">
            <Component Id="libcrypto_1_1.dll" Guid="$(var.libcrypto_1_1.dll.ComponentGUID)">
                <File Source="$(var.OpenVPN.Dir)libcrypto-1_1$(var.OpenSSL.Platform).dll"/>
            </Component>
            <Component Id="libssl_1_1.dll" Guid="$(var.libssl_1_1.dll.ComponentGUID)">
                <File Source="$(var.OpenVPN.Dir)libssl-1_1$(var.OpenSSL.Platform).dll"/>
            </Component>
            <Component Id="liblzo2_2.dll" Guid="$(var.liblzo2_2.dll.ComponentGUID)">
                <File Source="$(var.OpenVPN.Dir)liblzo2-2.dll"/>
            </Component>
            <Component Id="libpkcs11_helper_1.dll" Guid="$(var.libpkcs11_helper_1.dll.ComponentGUID)">
                <File Source="$(var.OpenVPN.Dir)libpkcs11-helper-1.dll"/>
            </Component>
            <Component Id="wintun.dll" Guid="{BCD1B70D-A1D3-4DC1-98$(var.ClientId)-8E90D8EF9FE0}">
                <File Source="$(var.OpenVPN.Dir)wintun.dll"/>
            </Component>
            <Component Id="openvpn.exe" Guid="$(var.openvpn.exe.ComponentGUID)">
                <File Source="$(var.OpenVPN.Dir)openvpn.exe"/>
            </Component>
            <Component Id="openvpnserv.exe" Guid="$(var.openvpnserv.exe.ComponentGUID)">
                <File Source="$(var.OpenVPN.Dir)openvpnserv.exe"/>
                <CreateFolder Directory="OPENVPNCONFIGDIR">
                    <!--
                        SYSTEM (SY): full
                        Administrators (BA): full
                        Users (BU): create files
                        CREATOR OWNER (CO): full
                    -->
                    <PermissionEx Id="OPENVPNCONFIGDIR" Sddl="D:PAI(A;OICI;FA;;;SY)(A;OICI;FA;;;BA)(A;;0x100003;;;BU)(A;OIIO;FA;;;CO)"/>
                </CreateFolder>
                <RemoveFile
                    Id="OPENVPNCONFIGDIR.conf"
                    Directory="OPENVPNCONFIGDIR"
                    Name="*.conf"
                    On="uninstall"/>
                <RemoveFile
                    Id="OPENVPNCONFIGDIR.txt"
                    Directory="OPENVPNCONFIGDIR"
                    Name="*.txt"
                    On="uninstall"/>
                <RemoveFolder
                    Id="OPENVPNCONFIGDIR"
                    Directory="OPENVPNCONFIGDIR"
                    On="uninstall"/>
                <?if $(var.ClientTarget) = "eduVPN"?>
                <!-- Until 1.0-alpha6, Interactive Service was installed as eduVPNServiceInteractive. -->
                <ServiceControl
                    Id="eduVPNServiceInteractive"
                    Name="eduVPNServiceInteractive"
                    Stop="install"
                    Remove="install"/>
                <?endif?>
                <ServiceControl
                    Id="OpenVPNServiceInteractive.$(var.ClientTarget)"
                    Name="OpenVPNServiceInteractive$$$(var.ClientTarget)"
                    Start="install"
                    Stop="both"
                    Remove="uninstall"/>
                <ServiceInstall
                    Id="OpenVPNServiceInteractive.$(var.ClientTarget)"
                    Name="OpenVPNServiceInteractive$$$(var.ClientTarget)"
                    DisplayName="@[RESDIR]eduVPN.Resources.dll,-$(var.IDS_CLIENT_PREFIX)5"
                    Description="@[RESDIR]eduVPN.Resources.dll,-$(var.IDS_CLIENT_PREFIX)6"
                    Arguments="-instance interactive $$$(var.ClientTarget)"
                    Type="ownProcess"
                    Start="auto"
                    ErrorControl="normal">
                    <ServiceDependency Id="Dhcp"/>
                </ServiceInstall>
            </Component>
            <Component Id="openvpnserv.exe.reg0" Guid="$(var.openvpnserv.exe.reg0.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Type="string"
                    Value="[OPENVPNDIR]"/>
            </Component>
            <Component Id="openvpnserv.exe.reg1" Guid="$(var.openvpnserv.exe.reg1.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="exe_path"
                    Type="string"
                    Value="[OPENVPNDIR]openvpn.exe"/>
            </Component>
            <Component Id="openvpnserv.exe.reg2" Guid="$(var.openvpnserv.exe.reg2.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="config_dir"
                    Type="string"
                    Value="[OPENVPNCONFIGDIR]"/>
            </Component>
            <Component Id="openvpnserv.exe.reg3" Guid="$(var.openvpnserv.exe.reg3.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="config_ext"
                    Type="string"
                    Value="conf"/>
            </Component>
            <Component Id="openvpnserv.exe.reg4" Guid="$(var.openvpnserv.exe.reg4.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="log_dir"
                    Type="string"
                    Value="[OPENVPNCONFIGDIR]"/>
            </Component>
            <Component Id="openvpnserv.exe.reg5" Guid="$(var.openvpnserv.exe.reg5.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="log_append"
                    Type="string"
                    Value="0"/>
            </Component>
            <Component Id="openvpnserv.exe.reg6" Guid="$(var.openvpnserv.exe.reg6.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="priority"
                    Type="string"
                    Value="NORMAL_PRIORITY_CLASS"/>
            </Component>
            <Component Id="openvpnserv.exe.reg7" Guid="$(var.openvpnserv.exe.reg7.ComponentGUID)">
                <RegistryValue
                    Root="HKLM"
                    Key="Software\OpenVPN$$$(var.ClientTarget)"
                    Name="ovpn_admin_group"
                    Type="string"
                    Value="Users"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="COREDIR">
            <Component Id="System.ValueTuple.dll" Guid="$(var.System.ValueTuple.dll.ComponentGUID)">
                <File Source="System.ValueTuple.dll"/>
            </Component>
            <Component Id="Prism.dll" Guid="$(var.Prism.dll.ComponentGUID)">
                <File Source="Prism.dll"/>
            </Component>
            <Component Id="eduEd25519.dll" Guid="{4D1F1278-9044-4AFD-98E1-71BB39FCB0F1}">
                <File Source="eduEd25519.dll"/>
            </Component>
            <Component Id="eduEx.dll" Guid="{153A001F-0206-4F9F-957E-43E00FB31B2B}">
                <File Source="eduEx.dll"/>
            </Component>
            <Component Id="eduJSON.dll" Guid="{BC7AF3B7-872E-405C-A319-391CA0FB40D4}">
                <File Source="eduJSON.dll"/>
            </Component>
            <Component Id="eduOAuth.dll" Guid="{8B85976D-4CFC-4543-B583-06C75E92A6FD}">
                <File Source="eduOAuth.dll"/>
            </Component>
            <Component Id="eduOpenVPN.dll" Guid="{809A5107-82D9-4271-BE32-37427C14BCA7}">
                <File Source="eduOpenVPN.dll"/>
            </Component>
            <Component Id="eduVPN.dll" Guid="{363C4CCB-B18B-4BA8-AB89-797564B388C2}">
                <File Source="eduVPN.dll"/>
            </Component>
            <Component Id="eduVPN.Views.dll" Guid="{34C9B131-FFE8-4A07-9393-9683C6FDB3F7}">
                <File Source="eduVPN.Views.dll"/>
            </Component>
            <Component Id="$(var.ClientTarget).Client.exe" Guid="$(var.Client.exe.ComponentGUID)">
                <File Source="$(var.ClientTarget).Client.exe" KeyPath="yes"/>

                <!-- Note: "$(var.ClientTarget).Client" feature and "App.ico" icon are defined elsewhere. -->
                <Shortcut
                    Id="$(var.ClientTarget).Client.exe.StartMenuShortcut"
                    Directory="ProgramMenuFolder"
                    Name="$(var.ClientTitle) Client" DisplayResourceDll="[RESDIR]eduVPN.Resources.dll" DisplayResourceId="$(var.IDS_CLIENT_PREFIX)1"
                    DescriptionResourceDll="[RESDIR]eduVPN.Resources.dll" DescriptionResourceId="$(var.IDS_CLIENT_PREFIX)2"
                    Target="$(var.ClientTarget).Client"
                    WorkingDirectory="COREDIR"
                    Icon="App.ico"/>
            </Component>
            <Component Id="$(var.ClientTarget).Client.exe.config" Guid="$(var.Client.exe.config.ComponentGUID)">
                <File Source="$(var.ClientTarget).Client.exe.config"/>
            </Component>
            <!--
            <Component Id="$(var.ClientTarget).Client.exe.DesktopShortcut" Guid="{C630B2C1-7CD1-4E9C-90$(var.ClientId)-1F6EA79C5D85}">
                <Shortcut
                    Id="$(var.ClientTarget).Client.exe.DesktopShortcut"
                    Directory="DesktopFolder"
                    Name="$(var.ClientTitle) Client" DisplayResourceDll="[RESDIR]eduVPN.Resources.dll" DisplayResourceId="$(var.IDS_CLIENT_PREFIX)1"
                    DescriptionResourceDll="[RESDIR]eduVPN.Resources.dll" DescriptionResourceId="$(var.IDS_CLIENT_PREFIX)2"
                    Target="[COREDIR]$(var.ClientTarget).Client.exe"
                    WorkingDirectory="COREDIR"
                    Icon="App.ico"/>
                <RemoveFolder Id="$(var.ClientTarget).Client.exe.DesktopShortcut" Directory="DesktopFolder" On="uninstall"/>
                <RegistryValue Root="HKCU" Key="SOFTWARE\$(var.ClientUrn)" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            -->

            <!-- Add/Remove Programs Localization -->
            <Component Id="ARP.DisplayName">
                <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.ProductGUID)" Name="DisplayName_Localized" Type="string" Value="@[RESDIR]eduVPN.Resources.dll,-$(var.IDS_CLIENT_PREFIX)1"/>

                <!-- Remove stale registry entries of old installations. -->
                <?foreach OldProductGUID in $(var.OldProductGUIDs)?>
                <RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.OldProductGUID)" Action="removeOnInstall"/>
                <?endforeach?>
            </Component>
            <Component Id="ARP.Publisher">
                <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.ProductGUID)" Name="Publisher_Localized" Type="string" Value="@[RESDIR]eduVPN.Resources.dll,-$(var.IDS_CLIENT_PREFIX)3"/>
            </Component>
        </DirectoryRef>
        <?foreach Language in $(var.LanguageList)?>
        <?include Install\$(var.Language)\defs.wxi?>
        <DirectoryRef Id="RESOURCEDIR$(var.LanguageId)">
            <Component Id="eduEd25519.resources.dll.$(var.LanguageId)" Guid="$(var.eduEd25519.resources.dll.ComponentGUID)">
                <File Id="eduEd25519.resources.dll.$(var.LanguageId)" Source="$(var.Language)\eduEd25519.resources.dll"/>
            </Component>
            <Component Id="eduJSON.resources.dll.$(var.LanguageId)" Guid="$(var.eduJSON.resources.dll.ComponentGUID)">
                <File Id="eduJSON.resources.dll.$(var.LanguageId)" Source="$(var.Language)\eduJSON.resources.dll"/>
            </Component>
            <Component Id="eduOAuth.resources.dll.$(var.LanguageId)" Guid="$(var.eduOAuth.resources.dll.ComponentGUID)">
                <File Id="eduOAuth.resources.dll.$(var.LanguageId)" Source="$(var.Language)\eduOAuth.resources.dll"/>
            </Component>
            <Component Id="eduOpenVPN.resources.dll.$(var.LanguageId)" Guid="$(var.eduOpenVPN.resources.dll.ComponentGUID)">
                <File Id="eduOpenVPN.resources.dll.$(var.LanguageId)" Source="$(var.Language)\eduOpenVPN.resources.dll"/>
            </Component>
            <Component Id="eduVPN.resources.dll.$(var.LanguageId)" Guid="$(var.eduVPN.resources.dll.ComponentGUID)">
                <File Id="eduVPN.resources.dll.$(var.LanguageId)" Source="$(var.Language)\eduVPN.resources.dll"/>
            </Component>
            <Component Id="eduVPN.Views.resources.dll.$(var.LanguageId)" Guid="$(var.eduVPN.Views.resources.dll.ComponentGUID)">
                <File Id="eduVPN.Views.resources.dll.$(var.LanguageId)" Source="$(var.Language)\eduVPN.Views.resources.dll"/>
            </Component>
        </DirectoryRef>
        <?endforeach?>


        <!--
            Features
        -->
        <Feature Id="$(var.ClientTarget).Client" Title="!(loc.$(var.ClientTarget).Name)" Level="1">
            <ComponentRef Id="eduVPN.Resources.dll"/>

            <ComponentRef Id="libcrypto_1_1.dll"/>
            <ComponentRef Id="libssl_1_1.dll"/>
            <ComponentRef Id="liblzo2_2.dll"/>
            <ComponentRef Id="libpkcs11_helper_1.dll"/>
            <ComponentRef Id="wintun.dll"/>
            <ComponentRef Id="openvpn.exe"/>
            <ComponentRef Id="openvpnserv.exe"/>
            <ComponentRef Id="openvpnserv.exe.reg0"/>
            <ComponentRef Id="openvpnserv.exe.reg1"/>
            <ComponentRef Id="openvpnserv.exe.reg2"/>
            <ComponentRef Id="openvpnserv.exe.reg3"/>
            <ComponentRef Id="openvpnserv.exe.reg4"/>
            <ComponentRef Id="openvpnserv.exe.reg5"/>
            <ComponentRef Id="openvpnserv.exe.reg6"/>
            <ComponentRef Id="openvpnserv.exe.reg7"/>

            <MergeRef Id="VC150Redist"/>
            <ComponentRef Id="System.ValueTuple.dll"/>
            <ComponentRef Id="Prism.dll"/>
            <ComponentRef Id="eduEd25519.dll"/>
            <ComponentRef Id="eduEx.dll"/>
            <ComponentRef Id="eduJSON.dll"/>
            <ComponentRef Id="eduOAuth.dll"/>
            <ComponentRef Id="eduOpenVPN.dll"/>
            <ComponentRef Id="eduVPN.dll"/>
            <ComponentRef Id="eduVPN.Views.dll"/>
            <ComponentRef Id="$(var.ClientTarget).Client.exe"/>
            <ComponentRef Id="$(var.ClientTarget).Client.exe.config"/>
            <!--<ComponentRef Id="$(var.ClientTarget).Client.exe.DesktopShortcut"/>-->
            <ComponentRef Id="ARP.DisplayName"/>
            <ComponentRef Id="ARP.Publisher"/>

            <?foreach Language in $(var.LanguageList)?>
            <?include Install\$(var.Language)\defs.wxi?>
            <ComponentRef Id="eduEd25519.resources.dll.$(var.LanguageId)"/>
            <ComponentRef Id="eduJSON.resources.dll.$(var.LanguageId)"/>
            <ComponentRef Id="eduOAuth.resources.dll.$(var.LanguageId)"/>
            <ComponentRef Id="eduOpenVPN.resources.dll.$(var.LanguageId)"/>
            <ComponentRef Id="eduVPN.resources.dll.$(var.LanguageId)"/>
            <ComponentRef Id="eduVPN.Views.resources.dll.$(var.LanguageId)"/>
            <?endforeach?>
        </Feature>


        <!--
            Custom Actions
        -->
        <CustomAction
            Id="EvaluateWintunPool"
            BinaryKey="OpenVPN.MSICA.dll"
            DllEntry="EvaluateWintunPool"/>

        <CustomAction
            Id="RemoveWintunPool"
            BinaryKey="OpenVPN.MSICA.dll"
            DllEntry="RemoveWintunPool"
            Execute="deferred"
            Impersonate="no"/>

        <InstallExecuteSequence>
            <Custom
                Action="EvaluateWintunPool"
                After="ProcessComponents"/>

            <Custom
                Action="RemoveWintunPool"
                Before="RemoveFiles"/>
        </InstallExecuteSequence>

        <UI>
            <Error Id="2550">!(OpenVPN.MSICA [2]: [3]: Error [4]: [5])</Error>
        </UI>
    </Product>
</Wix>

<?xml version="1.0" encoding="utf-8"?>
<!--
    eduVPN - VPN for education and research

    Copyright: 2017-2021 The Commons Conservancy eduVPN Programme
    SPDX-License-Identifier: GPL-3.0+
-->

<?if $(var.Platform) = "x64"?>
    <?define OldProductGUIDs={03CB2E09-0CAD-469B-AB45-655D66FE3B65};{0B43FFC8-2FCD-461E-A2AE-16F9DC6A183D};{0ECF4980-96D5-47B5-B1E0-FDDBEF02BF54};{16D1732B-40C4-497E-A4B9-F71E809F954D};{2ABA1066-30E5-43CE-921A-913A51A7ACB9};{37F3A6BD-34BA-4495-B6D2-906BB7AE7F90};{3B2B4912-3847-4D91-A326-B96094959E8B};{41FE8D9A-4F4E-4C9D-8FA0-2C084D8AA2D2};{42667D99-70EE-4550-96CA-D65E5C43309E};{476E2607-8BA4-42B0-8B30-B6AC07158419};{5232255B-AEFF-48EB-B7D2-D9DDE5EB9239};{5461A901-8935-4D30-A1E2-78EF195D4EC2};{5CCC8478-91E6-49B0-9C30-6518E5CC4EBE};{74A83B8A-B4A7-4E3E-B19E-2D63AB86BC70};{78448237-611C-4132-8696-C4A202605618};{78738805-E2DC-407B-89E7-A26D789BAF9E};{7B1FBFE6-92B3-4B6D-A808-A26DF770606A};{803E3649-24C4-4F8B-AB5E-59EE7B3736BF};{815F3BBF-56B0-4AA1-B3A4-EAD2D68FCDE7};{8AA8BC85-09C9-47D0-8284-3E79D64D88F1};{8C3E9E9C-CC76-4F8D-A6EB-B2355451F938};{8C8D0D69-B3BB-444C-BD32-2941AA86A3BF};{A2BC5B6A-7DF3-4BC4-AB30-A8492DAD41D2};{CD8D16F9-340D-4865-9164-9D0EE4B6F77C};{CDFB4BCC-FAB4-4DED-85DB-853B921E6050};{CFEF527D-232C-49D5-9A86-BEF160F048BE};{E5D753A3-D50A-4484-B07F-307CFEA5DA49};{F018B421-F402-43E6-A0BE-2B9143C24CAD}?>
<?elseif $(var.Platform) = "x86"?>
    <?define OldProductGUIDs={03CB2E09-0CAD-469B-AB45-655D66FE3B65};{0B43FFC8-2FCD-461E-A2AE-16F9DC6A183D};{0ECF4980-96D5-47B5-B1E0-FDDBEF02BF54};{16D1732B-40C4-497E-A4B9-F71E809F954D};{2ABA1066-30E5-43CE-921A-913A51A7ACB9};{37F3A6BD-34BA-4495-B6D2-906BB7AE7F90};{38416F1D-6D51-41DB-9144-6660747695DE};{3B2B4912-3847-4D91-A326-B96094959E8B};{3D4EDD0B-AAB5-4B20-90A1-363C0FD39F21};{41FE8D9A-4F4E-4C9D-8FA0-2C084D8AA2D2};{476E2607-8BA4-42B0-8B30-B6AC07158419};{5232255B-AEFF-48EB-B7D2-D9DDE5EB9239};{5461A901-8935-4D30-A1E2-78EF195D4EC2};{5CCC8478-91E6-49B0-9C30-6518E5CC4EBE};{74A83B8A-B4A7-4E3E-B19E-2D63AB86BC70};{78738805-E2DC-407B-89E7-A26D789BAF9E};{7B1FBFE6-92B3-4B6D-A808-A26DF770606A};{803E3649-24C4-4F8B-AB5E-59EE7B3736BF};{815F3BBF-56B0-4AA1-B3A4-EAD2D68FCDE7};{8AA8BC85-09C9-47D0-8284-3E79D64D88F1};{8C3E9E9C-CC76-4F8D-A6EB-B2355451F938};{8C8D0D69-B3BB-444C-BD32-2941AA86A3BF};{A2BC5B6A-7DF3-4BC4-AB30-A8492DAD41D2};{CD8D16F9-340D-4865-9164-9D0EE4B6F77C};{CDFB4BCC-FAB4-4DED-85DB-853B921E6050};{CFEF527D-232C-49D5-9A86-BEF160F048BE};{E5D753A3-D50A-4484-B07F-307CFEA5DA49};{F018B421-F402-43E6-A0BE-2B9143C24CAD}?>
<?else?>
    <?error Unknown platform ?>
<?endif?>

<Wix
    xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
    <Product
        Id="$(var.Core.ProductGUID)"
        UpgradeCode="$(var.Core.UpgradeGUID)"
        Version="$(var.Core.Version)"
        Language="!(loc.ProductLanguage)"
        Name="!(loc.$(var.ClientTarget).CoreName) $(var.Core.VersionInformational)"
        Manufacturer="!(loc.ManufacturerName)">

        <Package
            InstallScope="perMachine"
            InstallerVersion="400"
            Compressed="yes"
            SummaryCodepage="!(loc.SummaryCodepage)"
            ReadOnly="yes"/>

        <Media
            Id="1"
            Cabinet="Core.cab"
            EmbedCab="yes"/>

        <Icon
            Id="App.ico"
            SourceFile="$(var.ClientTarget).Client\Resources\App.ico"/>

        <Property Id="ARPPRODUCTICON" Value="App.ico"/>
        <Property Id="ARPURLINFOABOUT" Value="$(var.ClientAboutUrl)"/>


        <!--
            Upgrading functionality
        -->
        <MajorUpgrade
            DowngradeErrorMessage="!(loc.NewerVersionInstalled)"
            Schedule="afterInstallExecute"
            AllowSameVersionUpgrades="yes"/>
        <Property Id="OLDVERSIONSINSTALLED" Secure="yes"/>
        <Upgrade Id="{ADD9689E-1061-43AF-85C6-2AAB99A7284E}">
            <UpgradeVersion
                Minimum="0.0.0.0"
                Maximum="1.0.10.0"
                Property="OLDVERSIONSINSTALLED"
                IncludeMinimum="yes"
                MigrateFeatures="yes"/>
        </Upgrade>
        <Property Id="BINDIRPREV">
            <ComponentSearch Id="Prism.dll" Guid="{7F1F7FAC-3959-40D5-A379-AE70762D6335}"/>
            <ComponentSearch Id="System.ValueTuple.dll" Guid="{2D4A9678-39A8-4623-8903-DCA55E9C24F4}"/>
            <ComponentSearch Id="$(var.ClientTarget).Client.exe" Guid="{ED87A5F5-CCED-46EA-8D4E-443CA747E4D8}"/>
            <ComponentSearch Id="$(var.ClientTarget).Client.exe.config" Guid="{8382A373-0C73-4D16-8F33-CA9FF91C24D0}"/>
        </Property>
        <SetProperty
            After="AppSearch"
            Action="SetBinDirPrev"
            Id="BINDIR"
            Value="[BINDIRPREV]"
            Sequence="first"><![CDATA[BINDIRPREV AND NOT Installed]]></SetProperty>
        <SetProperty
            After="SetBinDirPrev"
            Action="SetBinDirParam"
            Id="BINDIR"
            Value="[INSTALLDIR]"
            Sequence="first"><![CDATA[INSTALLDIR AND NOT Installed]]></SetProperty>


        <!--
            .NET Framework check
        -->
        <PropertyRef Id="NETFRAMEWORK45"/>
        <Condition Message="!(loc.DotNETFrameworkMissing)"><![CDATA[Installed OR NETFRAMEWORK45]]></Condition>


        <!--
            Folders
        -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.ProgramFilesFolder)">
                <Directory Id="PRODUCTDIR" Name="$(var.ClientTitle)">
                    <Directory Id="BINDIR" Name="Core" FileSource="$(var.TargetDir)">
                        <Directory Id="RESDIRAR"   Name="ar"/>
                        <Directory Id="RESDIRDE"   Name="de"/>
                        <Directory Id="RESDIRFR"   Name="fr"/>
                        <Directory Id="RESDIRNB"   Name="nb"/>
                        <Directory Id="RESDIRNL"   Name="nl"/>
                        <Directory Id="RESDIRPTPT" Name="pt-PT"/>
                        <Directory Id="RESDIRSL"   Name="sl"/>
                        <Directory Id="RESDIRTR"   Name="tr"/>
                        <Directory Id="RESDIRUK"   Name="uk"/>
                    </Directory>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder"/>
            <Directory Id="DesktopFolder"/>

            <Merge Id="VC150Redist" SourceFile="$(var.VC150RedistMSM)" DiskId="1" Language="0"/>
        </Directory>


        <!--
            Compontents
        -->
        <DirectoryRef Id="BINDIR">
            <!-- Add/Remove Programs Localization -->
            <Component Id="ARP.DisplayName">
                <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.Core.ProductGUID)" Name="DisplayName_Localized" Type="string" Value="@[BINDIR]eduVPN.Resources.dll,-4"/>

                <!-- Remove stale registry entries of old installations. -->
                <?foreach OldProductGUID in $(var.OldProductGUIDs)?>
                <RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.OldProductGUID)" Action="removeOnInstall"/>
                <?endforeach?>
            </Component>
            <Component Id="ARP.Publisher">
                <RegistryValue Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.Core.ProductGUID)" Name="Publisher_Localized" Type="string" Value="@[BINDIR]eduVPN.Resources.dll,-3"/>
            </Component>
        </DirectoryRef>


        <!--
            Features
        -->
        <Feature Id="$(var.ClientTarget).Client" Title="!(loc.$(var.ClientTarget).CoreName)" Level="1">
            <MergeRef Id="VC150Redist"/>
            <ComponentRef Id="ARP.DisplayName"/>
            <ComponentRef Id="ARP.Publisher"/>

            <ComponentGroupRef Id="$(var.ClientTarget).Client.exe"/>
        </Feature>


        <!--
            Prism.dll
        -->
        <DirectoryRef Id="BINDIR">
            <Component Id="Prism.dll" Guid="{7F1F7FAC-3959-40D5-A379-AE70762D6335}">
                <File Source="Prism.dll"/>
            </Component>
        </DirectoryRef>
        <ComponentGroup Id="Prism.dll">
            <ComponentRef Id="Prism.dll"/>
            <ComponentRef Id="System.ValueTuple.dll"/>
        </ComponentGroup>


        <!--
            System.ValueTuple.dll
        -->
        <DirectoryRef Id="BINDIR">
            <Component Id="System.ValueTuple.dll" Guid="{2D4A9678-39A8-4623-8903-DCA55E9C24F4}">
                <File Source="System.ValueTuple.dll"/>
            </Component>
        </DirectoryRef>
        <ComponentGroup Id="System.ValueTuple.dll">
            <ComponentRef Id="System.ValueTuple.dll"/>
        </ComponentGroup>
    </Product>
</Wix>
